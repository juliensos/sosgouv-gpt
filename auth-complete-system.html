<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>SOSGOUV – Auth complète (password + email + Google)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;max-width:900px;margin:24px auto;padding:0 16px}
    h1{font-size:22px}
    h2{margin:24px 0 8px;font-size:18px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,button,select{padding:8px 10px;font-size:14px}
    button{cursor:pointer}
    .msg{margin-top:6px;color:#444}
    .members{margin-top:16px;border:1px solid #eee;border-radius:8px;padding:12px}
    .muted{color:#777}
    .divider{height:1px;background:#eee;margin:16px 0}
    .ok{color:#2e7d32}.err{color:#c62828}
    code{background:#f6f6f6;padding:2px 4px;border-radius:4px}
  </style>
</head>
<body>
  <h1>Page de contrôle – Comptes & membres</h1>
  <p class="muted">Projet: <code>https://uwevblhmiphktgamhnik.supabase.co</code></p>

  <section>
    <h2>Connexion (3 options)</h2>
    <div class="row">
      <input id="username" placeholder="Pseudo (ex: ju42)" />
      <input id="password" type="password" placeholder="Mot de passe" />
      <button id="signup-anon">Créer (anonyme)</button>
      <input id="email" placeholder="email (option 2)" />
      <button id="signup-email">Créer (avec e-mail)</button>
      <button id="login-password">Se connecter (mot de passe)</button>
      <button id="login-google">Se connecter avec Google</button>
      <button id="logout">Se déconnecter</button>
    </div>
    <div id="auth-msg" class="msg"></div>
    <div id="session" class="msg muted"></div>
  </section>

  <div class="divider"></div>

  <section class="members">
    <h2>Membres (profiles)</h2>
    <div id="members-list" class="muted">Chargement…</div>
  </section>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabase = createClient(
      "https://uwevblhmiphktgamhnik.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV3ZXZibGhtaXBoa3RnYW1obmlrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MDM4MjQsImV4cCI6MjA3NjE3OTgyNH0.4SkvVKy7bcRDsMffOuYbkM2oYtHdBbsMx2KOu4G4MJo"
    );

    const $ = id => document.getElementById(id);
    const msg = $("auth-msg");
    const sessEl = $("session");
    const listEl = $("members-list");

    const pseudoEmail = (u) => `${u}@sosgouv.local`;
    const setMsg = (t, ok=false)=>{ msg.textContent = t; msg.className = 'msg ' + (ok?'ok':'err'); };

    async function ensureProfileFor(user) {
      if (!user) return;
      const { data: existing, error: exErr } = await supabase
        .from("profiles").select("id").eq("id", user.id).maybeSingle();
      if (exErr) { console.error(exErr); return; }
      if (existing) return;

      const username =
        (user.user_metadata && (user.user_metadata.full_name || user.user_metadata.name)) ?
          (user.user_metadata.full_name || user.user_metadata.name).split(" ")[0] :
        (user.email ? user.email.split("@")[0] : `user_${user.id.slice(0,6)}`);

      const email = user.email ?? null;
      const { error: insErr } = await supabase.from("profiles").insert({
        id: user.id, username, email
      });
      if (insErr) console.error(insErr);
    }

    async function refreshSession() {
      const { data:{ session } } = await supabase.auth.getSession();
      if (session?.user) {
        const u = session.user;
        await ensureProfileFor(u);

        let display = u.email || (u.user_metadata && (u.user_metadata.full_name || u.user_metadata.name)) || u.id;
        const { data: prof } = await supabase
          .from("profiles").select("username,email").eq("id", u.id).maybeSingle();
        if (prof?.username) display = prof.username;
        sessEl.textContent = "Connecté : " + display;
      } else {
        sessEl.textContent = "Non connecté";
      }
      await loadMembers();
    }

    async function loadMembers() {
      const { data, error } = await supabase
        .from("profiles")
        .select("username,email,created_at")
        .order("created_at", { ascending:false });
      if (error) { listEl.textContent = "Erreur : " + error.message; return; }
      if (!data || !data.length) { listEl.textContent = "Aucun membre pour l’instant."; return; }
      listEl.innerHTML = data.map(m => {
        const mail = m.email ? ` · ${m.email}` : " · (anonyme)";
        return `<div>${m.username}${mail}</div>`;
      }).join("");
    }

    document.getElementById("signup-anon").addEventListener("click", async () => {
      const username = $("username").value.trim();
      const password = $("password").value;
      if (!username || !password) { setMsg("Pseudo & mot de passe requis."); return; }

      const email = pseudoEmail(username);
      const res = await supabase.auth.signUp({ email, password });
      if (res.error) { setMsg("Erreur création : " + res.error.message); return; }
      await ensureProfileFor(res.data.user);
      await supabase.from("profiles").update({ email: null, username }).eq("id", res.data.user.id);

      setMsg("Compte (anonyme) créé.", true);
      await refreshSession();
    });

    document.getElementById("signup-email").addEventListener("click", async () => {
      const username = $("username").value.trim();
      const password = $("password").value;
      const email = $("email").value.trim();
      if (!username || !password || !email) { setMsg("Pseudo, mot de passe et e-mail requis."); return; }

      const res = await supabase.auth.signUp({ email, password });
      if (res.error) { setMsg("Erreur création : " + res.error.message); return; }
      await ensureProfileFor(res.data.user);
      await supabase.from("profiles").update({ username, email }).eq("id", res.data.user.id);

      setMsg("Compte (e-mail) créé.", true);
      await refreshSession();
    });

    document.getElementById("login-password").addEventListener("click", async () => {
      const username = $("username").value.trim();
      const password = $("password").value;
      const emailField = $("email").value.trim();
      if (!username || !password) { setMsg("Pseudo & mot de passe requis."); return; }

      const email = emailField || pseudoEmail(username);
      const res = await supabase.auth.signInWithPassword({ email, password });
      if (res.error) { setMsg("Erreur connexion : " + res.error.message); return; }
      setMsg("Connecté.", true);
      await refreshSession();
    });

    document.getElementById("login-google").addEventListener("click", async () => {
      const { error } = await supabase.auth.signInWithOAuth({
        provider: "google",
        options: {
          redirectTo: window.location.href,
          queryParams: { prompt: "select_account" }
        }
      });
      if (error) setMsg("Erreur Google OAuth : " + error.message);
    });

    document.getElementById("logout").addEventListener("click", async () => {
      await supabase.auth.signOut();
      setMsg("Déconnecté.", true);
      await refreshSession();
    });

    supabase.auth.onAuthStateChange(() => refreshSession());
    refreshSession();
  </script>
</body>
</html>
